<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Transcoder</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
    }

    .container {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 400px;  /* won't get too wide on large screens */
        text-align: center;
        box-sizing: border-box;
    }

    form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px; /* spacing between inputs/buttons */
    }

    input, select, button {
        width: 90%;          /* dynamic width based on container */
        max-width: 100%;     /* never overflow container */
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        font-size: 1rem;
    }

    button {
        cursor: pointer;
        background-color: #4CAF50;
        color: white;
        border: none;
    }

    button:hover {
        background-color: #45a049;
    }

    #status {
        margin-top: 15px;
        font-weight: bold;
    }

    #download-link {
        display: none;
        margin-top: 10px;
        word-break: break-all;
    }

    /* Mobile adjustments */
    @media (max-width: 500px) {
        .container {
        width: 95%;
        padding: 15px;
        }
        input, select, button {
        width: 100%;
        font-size: 0.95rem;
        }
    }
    </style>

</head>
<body>
<div class="container">
  <h2>üé• Video Transcoder</h2>

  <!-- LOGIN FORM -->
  <form id="loginForm">
    <input type="text" name="username" placeholder="Username" required />
    <input type="password" name="password" placeholder="Password" required />
    <button type="submit">Login</button>
  </form>

  <!-- VIDEO UPLOAD FORM -->
  <form id="uploadForm" style="display:none;">
    <input type="file" name="video" accept="video/*" required />
    <select name="resolution" required>
      <option value="">Select Resolution</option>
      <option value="640x360">360p</option>
      <option value="1280x720">720p</option>
      <option value="1920x1080">1080p</option>
    </select>
    <button type="submit">Transcode</button>
  </form>

  <p id="status"></p>
  <a id="download-link" href="#" download>‚¨áÔ∏è Download Transcoded Video</a>
</div>

<div id="adminPanel" style="display:none;">
  <h3>‚ö° Admin Panel</h3>
  <p>CPU Usage: <span id="cpuUsage">0%</span></p>
  <button id="refreshCpu">Refresh</button>
</div>

<script>
let jwtToken = '';
const loginForm = document.getElementById('loginForm');
const uploadForm = document.getElementById('uploadForm');
const status = document.getElementById('status');
const downloadLink = document.getElementById('download-link');
const adminPanel = document.getElementById('adminPanel');
const cpuUsageEl = document.getElementById('cpuUsage');
const refreshCpuBtn = document.getElementById('refreshCpu');

// Function to fetch CPU usage for admin
async function fetchCpu() {
  if (!jwtToken) return;
  try {
    const res = await fetch('/cpu', {
      headers: { 'Authorization': 'Bearer ' + jwtToken }
    });
    if (!res.ok) throw new Error('Access denied');
    const data = await res.json();
    cpuUsageEl.textContent = data.cpuUsage;
  } catch (err) {
    console.error(err);
    cpuUsageEl.textContent = 'Cannot fetch CPU usage';
  }
}

function showAdminPanel(token) {
    adminPanel.style.display = 'block';

    async function fetchCpu() {
        try {
            const res = await fetch('/cpu', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                const data = await res.json();
                cpuUsageEl.textContent = data.cpuUsage;
            } else {
                cpuUsageEl.textContent = 'Error fetching CPU';
            }
        } catch (err) {
            cpuUsageEl.textContent = 'Error fetching CPU';
        }
    }

    // Initial fetch
    fetchCpu();

    // Auto-update every 5 seconds
    const intervalId = setInterval(fetchCpu, 5000);

    // Optional: refresh button
    refreshCpuBtn.onclick = fetchCpu;

    // Optional: stop interval when logging out (if you implement logout)
    return intervalId;
}


// LOGIN
loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(loginForm);
    const username = formData.get('username');
    const password = formData.get('password');

    try {
        const response = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const result = await response.json();

        if (result.token) {
            jwtToken = result.token;
            status.textContent = '‚úÖ Login successful!';
            loginForm.style.display = 'none';
            uploadForm.style.display = 'block';

            const payload = JSON.parse(atob(jwtToken.split('.')[1]));
            if (payload.role === 'admin') {
                showAdminPanel(jwtToken); // show CPU panel for admins
            }

        } else {
            status.textContent = '‚ùå Login failed!';
        }
    } catch (err) {
        status.textContent = '‚ùå Login error!';
    }
});



// VIDEO UPLOAD
uploadForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!jwtToken) {
    status.textContent = '‚ùå You must login first!';
    return;
  }

  status.textContent = 'Uploading & Transcoding... ‚è≥';
  downloadLink.style.display = 'none';
  const formData = new FormData(uploadForm);

  try {
    const response = await fetch('/upload', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + jwtToken },
      body: formData
    });
    const result = await response.json();
    if (result.outputFile) {
      status.textContent = '‚úÖ Transcoding completed!';
      downloadLink.href = result.outputFile;
      downloadLink.style.display = 'block';
    } else {
      status.textContent = '‚ùå Error: ' + (result.error || 'Unknown');
    }
  } catch (error) {
    status.textContent = '‚ùå Something went wrong!';
  }
});
</script>
</body>
</html>