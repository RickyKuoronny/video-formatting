<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Video Resizer Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:800px; margin:20px auto; padding:0 16px; }
    input, select, button { padding:8px; margin:6px 0; width:100%; box-sizing:border-box; }
    label { font-weight:600; display:block; margin-top:8px; }
    .result { margin-top:12px; word-break:break-all; }
    #uploader, #adminPanel, #adminBtn { display:none; margin-top:20px; }
    canvas { max-width:100%; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:left; }
    th { background:#eee; }
  </style>
</head>
<body>
  <h1>Video Resizer</h1>

  <!-- LOGIN -->
  <div id="loginForm">
    <h2>Login</h2>
    <label>Username</label>
    <input id="username" type="text" />
    <label>Password</label>
    <input id="password" type="password" />
    <button id="loginBtn">Login</button>
  </div>

  <!-- UPLOADER -->
  <div id="uploader">
    <h2>Upload Video</h2>
    <label>Video file</label>
    <input id="video" type="file" accept="video/*" />
    <label>Resolution</label>
    <select id="resolution">
      <option value="">-- Select Resolution --</option>
        <option value="640x360">360p</option>
        <option value="1280x720">720p</option>
        <option value="1920x1080">1080p</option>
    </select>
    <button id="uploadBtn">Upload & Convert</button>

    <!-- Progress bar -->
    <div style="margin-top:10px; display:flex; align-items:center;">
        <progress id="uploadProgress" value="0" max="100" style="flex:1; margin-right:10px;"></progress>
        <span id="progressText">0%</span>
    </div>

    <div id="status" class="result"></div>
  </div>

  <!-- ADMIN BUTTON -->
  <button id="adminBtn">Admin</button>

  <!-- ADMIN PANEL -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <h3>CPU Usage (Live)</h3>
    <canvas id="cpuChart"></canvas>
    <h3>Conversion Logs</h3>
    <table id="logsTable">
      <thead>
        <tr>
          <th>User</th>
          <th>Input</th>
          <th>Output</th>
          <th>Resolution</th>
          <th>Started At</th>
          <th>Completed At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let jwtToken = null;
    let cpuChart = null;
    const cpuData = { labels: [], datasets: [{ label: 'CPU Load', data: [], borderColor: 'rgb(75, 192, 192)', tension: 0.3 }] };
    let cpuInterval = null;

    // LOGIN
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      if (!username || !password) { alert('Enter username and password'); return; }

      try {
        const resp = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const json = await resp.json();
        if (!resp.ok) throw new Error(json.error || 'Login failed');

        jwtToken = json.token;
        alert('Login successful!');

        // Hide login form, show uploader
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('uploader').style.display = 'block';

        // Only show admin button if admin
        const payload = JSON.parse(atob(jwtToken.split('.')[1]));
        if (payload.role === 'admin') {
          document.getElementById('adminBtn').style.display = 'block';
        }
      } catch (err) { alert('Login error: ' + (err.message || err)); }
    });

    // UPLOAD
    document.getElementById('uploadBtn').addEventListener('click', () => {
    if (!jwtToken) { alert('Please login first'); return; }
    const fileEl = document.getElementById('video');
    const res = document.getElementById('resolution').value;
    if (!fileEl.files.length) { alert('Choose a video'); return; }
    if (!res) { alert('Select resolution'); return; }

    // Disable inputs while uploading
    fileEl.disabled = true;
    document.getElementById('resolution').disabled = true;
    document.getElementById('uploadBtn').disabled = true;

    const fd = new FormData();
    fd.append('video', fileEl.files[0]);
    fd.append('resolution', res);

    const statusEl = document.getElementById('status');
    const progressBar = document.getElementById('uploadProgress');
    const progressText = document.getElementById('progressText');

    progressBar.value = 0;
    progressText.textContent = '0%';
    statusEl.textContent = 'Uploading...';

    // Use XMLHttpRequest to track progress
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/convert', true);
    xhr.setRequestHeader('Authorization', 'Bearer ' + jwtToken);

    xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
        const percent = Math.round((event.loaded / event.total) * 100);
        progressBar.value = percent;
        progressText.textContent = percent + '%';
        }
    };

    xhr.onload = () => {
        fileEl.disabled = false;
        document.getElementById('resolution').disabled = false;
        document.getElementById('uploadBtn').disabled = false;

        if (xhr.status === 200) {
        const json = JSON.parse(xhr.responseText);
        statusEl.innerHTML = 'Converted! <a href="' + json.download + '" target="_blank">Download here</a>';
        } else {
        let errMsg = 'Upload failed';
        try { errMsg = JSON.parse(xhr.responseText).error || errMsg; } catch {}
        statusEl.textContent = 'Error: ' + errMsg;
        }
    };

    xhr.onerror = () => {
        fileEl.disabled = false;
        document.getElementById('resolution').disabled = false;
        document.getElementById('uploadBtn').disabled = false;
        statusEl.textContent = 'Error: Upload failed';
    };

    xhr.send(fd);
    });


    // ADMIN BUTTON CLICK
    document.getElementById('adminBtn').addEventListener('click', async () => {
      document.getElementById('adminPanel').style.display = 'block';
      await fetchLogs();
      initCpuChart();
      if (!cpuInterval) cpuInterval = setInterval(updateCpuChart, 5000);
    });

    // FETCH LOGS
    async function fetchLogs() {
      try {
        const resp = await fetch('/logs', { headers: { 'Authorization': 'Bearer ' + jwtToken } });
        const json = await resp.json();
        if (!resp.ok) throw new Error(json.error || 'Failed to fetch logs');

        const tbody = document.querySelector('#logsTable tbody');
        tbody.innerHTML = '';
        json.logs.forEach(log => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${log.user}</td>
            <td>${log.input}</td>
            <td>${log.output}</td>
            <td>${log.resolution}</td>
            <td>${log.startedAt}</td>
            <td>${log.completedAt}</td>
          `;
          tbody.appendChild(tr);
        });

        // Initialize CPU chart with first value
        cpuData.datasets[0].data = json.cpuUsagePercent;
        cpuData.labels = [new Date().toLocaleTimeString()];
      } catch (err) { console.error('Error fetching logs:', err); }
    }

    // CPU Chart
    function initCpuChart() {
      const ctx = document.getElementById('cpuChart').getContext('2d');
      cpuChart = new Chart(ctx, { type: 'line', data: cpuData, options: { responsive:true, animation:false, scales:{ y:{ min:0 } } } });
    }

    async function updateCpuChart() {
      try {
        const resp = await fetch('/logs', { headers: { 'Authorization': 'Bearer ' + jwtToken } });
        const json = await resp.json();
        const now = new Date().toLocaleTimeString();
        cpuData.labels.push(now);
        cpuData.datasets[0].data.push(json.cpuUsagePercent[0]); // 1-min load
        if (cpuData.labels.length > 20) {
          cpuData.labels.shift();
          cpuData.datasets[0].data.shift();
        }
        cpuChart.update();
      } catch(err) { console.error('CPU chart update error:', err); }
    }
  </script>
</body>
</html>
