<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Video Transcoder</title>
 <style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
    }

    .container {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 400px;  /* won't get too wide on large screens */
        text-align: center;
        box-sizing: border-box;
        position: relative; 
    }

    form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px; /* spacing between inputs/buttons */
    }

    input, select, button {
        width: 90%;          /* dynamic width based on container */
        max-width: 100%;     /* never overflow container */
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        font-size: 1rem;
    }

    button {
        cursor: pointer;
        background-color: #4CAF50;
        color: white;
        border: none;
    }

    button:hover {
        background-color: #45a049;
    }

    #status {
        margin-top: 15px;
        font-weight: bold;
    }

    #download-link {
        display: none;
        margin-top: 10px;
        word-break: break-all;
    }
    #adminIcon {
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: pointer;
    font-size: 24px;
    }
    #adminPanel {
        display: none;
        position: absolute;
        top: 0;
        left: 420px;
        width: 400px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        padding: 20px;
        text-align: center;
    }

    /* Mobile adjustments */
    @media (max-width: 500px) {
        .container {
        width: 95%;
        padding: 15px;
        }
        input, select, button {
        width: 100%;
        font-size: 0.95rem;
        }
    }
    </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <h2>üé• Video Transcoder</h2>

    <form id="loginForm">
        <input type="text" name="username" placeholder="Username" required />
        <input type="password" name="password" placeholder="Password" required />
        <button type="submit">Login</button>
    </form>

    <form id="uploadForm" style="display:none;">
        <input type="file" name="video" accept="video/*" required />
        <select name="resolution" required>
            <option value="">Select Resolution</option>
            <option value="640x360">360p</option>
            <option value="1280x720">720p</option>
            <option value="1920x1080">1080p</option>
        </select>
        <button type="submit">Transcode</button>
    </form>

    <p id="status"></p>
    <a id="download-link" href="#" download>‚¨áÔ∏è Download Transcoded Video</a>

<div id="adminIcon" title="Show Admin Panel" style="display:none;">üë§</div>


<div id="adminPanel">
    <h3>‚ö° Admin Panel</h3>
    <canvas id="cpuChart" width="380" height="200"></canvas>
</div>

<script>
let jwtToken = '';
const loginForm = document.getElementById('loginForm');
const uploadForm = document.getElementById('uploadForm');
const status = document.getElementById('status');
const downloadLink = document.getElementById('download-link');
const adminIcon = document.getElementById('adminIcon');
const adminPanel = document.getElementById('adminPanel');

let cpuChart, intervalId;
let cpuData = { labels: [], datasets: [{ label:'CPU Usage (%)', data:[], borderColor:'rgba(75,192,192,1)', fill:false, tension:0.3 }] };

// Login handler
loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(loginForm);
    const username = formData.get('username');
    const password = formData.get('password');

    try {
        const res = await fetch('/login', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ username, password })
        });
        const result = await res.json();

        if (result.token) {
            jwtToken = result.token;
            status.textContent = '‚úÖ Login successful!';
            loginForm.style.display = 'none';
            uploadForm.style.display = 'block';

            // decode JWT to check role
            const payload = JSON.parse(atob(jwtToken.split('.')[1]));
            if (payload.role === 'admin') {
                // show admin icon only for admins
                adminIcon.style.display = 'block';
            }
        } else {
            status.textContent = '‚ùå Login failed!';
        }
    } catch(err) {
        console.error(err);
        status.textContent = '‚ùå Login error!';
    }
});



// Upload handler
uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!jwtToken) { status.textContent = '‚ùå Login first!'; return; }

    status.textContent = 'Uploading & Transcoding... ‚è≥';
    downloadLink.style.display = 'none';
    const formData = new FormData(uploadForm);

    try {
        const res = await fetch('/upload', {
            method:'POST',
            headers:{ 'Authorization':'Bearer ' + jwtToken },
            body: formData
        });
        const result = await res.json();
        if (result.outputFile) {
            status.textContent = '‚úÖ Transcoding completed!';
            downloadLink.href = result.outputFile;
            downloadLink.style.display = 'block';
        } else {
            status.textContent = '‚ùå Error: ' + (result.error || 'Unknown');
        }
    } catch(err) {
        console.error(err);
        status.textContent = '‚ùå Something went wrong!';
    }
});

// Admin panel toggle & chart
adminIcon.onclick = () => {
    if (adminPanel.style.display === 'none') {
        adminPanel.style.display = 'block';

        // initialize chart if first time
        if (!cpuChart) {
            const ctx = document.getElementById('cpuChart').getContext('2d');
            cpuChart = new Chart(ctx, { type:'line', data: cpuData, options:{ scales:{ x:{ title:{ display:true, text:'Time' } }, y:{ min:0,max:100,title:{ display:true,text:'CPU Usage (%)' } } } } });
        }

        // fetch CPU every 5s
        const fetchCpu = async () => {
            try {
                const res = await fetch('/cpu', { headers:{ 'Authorization':'Bearer ' + jwtToken } });
                if (!res.ok) throw new Error('Access denied');
                const data = await res.json();
                const timestamp = new Date().toLocaleTimeString();

                if (cpuData.labels.length >= 12) { cpuData.labels.shift(); cpuData.datasets[0].data.shift(); }
                cpuData.labels.push(timestamp);
                cpuData.datasets[0].data.push(parseFloat(data.cpuUsage));
                cpuChart.update();
            } catch(err){ console.error(err); }
        };

        fetchCpu();
        intervalId = setInterval(fetchCpu, 5000);

    } else {
        adminPanel.style.display = 'none';
        clearInterval(intervalId);
    }
};
</script>

</body>
</html>
